{
  "_doc": "Reusable combined panel: colored mode background blocks with a temperature line overlaid on top.",
  "_usage": "Copy this panel into any dashboard. Query A outputs mode background series using union() — each mode is a separate _field with value 100 when active, 0 otherwise. Query B outputs the temperature line (_field as label, _value in °C). The right Y-axis auto-scales to temperature range (default 20-45°C). Update mode names/colors in overrides and adjust min/max on the Temperature override to match your data range.",
  "datasource": {
    "type": "influxdb",
    "uid": "${DS_INFLUXDB}"
  },
  "fieldConfig": {
    "defaults": {
      "color": {
        "mode": "fixed",
        "fixedColor": "#B0B0B0"
      },
      "custom": {
        "axisCenteredZero": false,
        "axisColorMode": "text",
        "axisLabel": "",
        "axisPlacement": "hidden",
        "drawStyle": "line",
        "fillOpacity": 50,
        "gradientMode": "none",
        "hideFrom": {
          "legend": false,
          "tooltip": false,
          "viz": false
        },
        "lineInterpolation": "stepAfter",
        "lineWidth": 0,
        "pointSize": 5,
        "scaleDistribution": {
          "type": "linear"
        },
        "showPoints": "never",
        "spanNulls": true,
        "stacking": {
          "group": "A",
          "mode": "normal"
        },
        "thresholdsStyle": {
          "mode": "off"
        }
      },
      "mappings": [],
      "min": 0,
      "max": 100,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          { "color": "green", "value": null }
        ]
      }
    },
    "overrides": [
      {
        "_comment": "Overlay line — change 'Temperature' to match your line series _field name. Adjust min/max for your data range.",
        "matcher": { "id": "byName", "options": "Temperature" },
        "properties": [
          { "id": "custom.drawStyle", "value": "line" },
          { "id": "custom.lineInterpolation", "value": "smooth" },
          { "id": "custom.lineWidth", "value": 2 },
          { "id": "custom.fillOpacity", "value": 0 },
          { "id": "custom.stacking", "value": { "group": "B", "mode": "none" } },
          { "id": "custom.axisPlacement", "value": "right" },
          { "id": "custom.axisLabel", "value": "Temperature (\u00b0C)" },
          { "id": "color", "value": { "mode": "fixed", "fixedColor": "#FF6347" } },
          { "id": "unit", "value": "celsius" },
          { "id": "min", "value": 20 },
          { "id": "max", "value": 45 }
        ]
      },
      {
        "_comment": "Mode background overrides — hidden from tooltip. Change names and colors to match your data.",
        "matcher": { "id": "byName", "options": "Direct" },
        "properties": [
          { "id": "color", "value": { "mode": "fixed", "fixedColor": "#73BFF2" } },
          { "id": "custom.hideFrom", "value": { "tooltip": true, "legend": false, "viz": false } }
        ]
      },
      {
        "matcher": { "id": "byName", "options": "Idle" },
        "properties": [
          { "id": "color", "value": { "mode": "fixed", "fixedColor": "#B0B0B0" } },
          { "id": "custom.hideFrom", "value": { "tooltip": true, "legend": false, "viz": false } }
        ]
      },
      {
        "matcher": { "id": "byName", "options": "Navigation" },
        "properties": [
          { "id": "color", "value": { "mode": "fixed", "fixedColor": "#8F3BB8" } },
          { "id": "custom.hideFrom", "value": { "tooltip": true, "legend": false, "viz": false } }
        ]
      },
      {
        "matcher": { "id": "byName", "options": "Station" },
        "properties": [
          { "id": "color", "value": { "mode": "fixed", "fixedColor": "#C840E9" } },
          { "id": "custom.hideFrom", "value": { "tooltip": true, "legend": false, "viz": false } }
        ]
      },
      {
        "matcher": { "id": "byName", "options": "Voyage" },
        "properties": [
          { "id": "color", "value": { "mode": "fixed", "fixedColor": "#3274D9" } },
          { "id": "custom.hideFrom", "value": { "tooltip": true, "legend": false, "viz": false } }
        ]
      }
    ]
  },
  "gridPos": {
    "h": 10,
    "w": 24,
    "x": 0,
    "y": 0
  },
  "options": {
    "legend": {
      "calcs": [],
      "displayMode": "list",
      "placement": "right",
      "showLegend": true
    },
    "tooltip": {
      "mode": "single",
      "sort": "none"
    }
  },
  "targets": [
    {
      "_comment": "Query A: Mode backgrounds — one series per state, value 100 when active, 0 otherwise. Replace measurement, field, and mode tag to match your data.",
      "query": "data = from(bucket: \"vessel-data\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"temperature\")\n  |> filter(fn: (r) => r._field == \"temperature_c\")\n  |> filter(fn: (r) => r.mission == \"${mission}\")\n  |> group()\n  |> aggregateWindow(every: 2m, fn: last, createEmpty: false)\n\nunion(tables: [\n  data |> map(fn: (r) => ({_time: r._time, _value: if r.mode == \"Direct\" then 100.0 else 0.0, _field: \"Direct\"})) |> group(columns: [\"_field\"]),\n  data |> map(fn: (r) => ({_time: r._time, _value: if r.mode == \"Idle\" then 100.0 else 0.0, _field: \"Idle\"})) |> group(columns: [\"_field\"]),\n  data |> map(fn: (r) => ({_time: r._time, _value: if r.mode == \"Navigation\" then 100.0 else 0.0, _field: \"Navigation\"})) |> group(columns: [\"_field\"]),\n  data |> map(fn: (r) => ({_time: r._time, _value: if r.mode == \"Station\" then 100.0 else 0.0, _field: \"Station\"})) |> group(columns: [\"_field\"]),\n  data |> map(fn: (r) => ({_time: r._time, _value: if r.mode == \"Voyage\" then 100.0 else 0.0, _field: \"Voyage\"})) |> group(columns: [\"_field\"])\n])",
      "refId": "A"
    },
    {
      "_comment": "Query B: Temperature line — aggregateWindow blends both sensor readings (ms_b and sht_b) into one smooth line. Use fn: mean for smoothing, fn: last to prefer one sensor.",
      "query": "from(bucket: \"vessel-data\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"temperature\")\n  |> filter(fn: (r) => r._field == \"temperature_c\")\n  |> filter(fn: (r) => r.mission == \"${mission}\")\n  |> group()\n  |> sort(columns: [\"_time\"])\n  |> aggregateWindow(every: 5m, fn: mean, createEmpty: false)\n  |> map(fn: (r) => ({_time: r._time, _value: r._value, _field: \"Temperature\"}))\n  |> group(columns: [\"_field\"])",
      "refId": "B"
    }
  ],
  "title": "Temperature over time",
  "type": "timeseries"
}
